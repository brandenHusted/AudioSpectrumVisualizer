<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Audio Player with Visualizer</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    text-align: center;
}

.container {
    max-width: 600px;
    padding: 20px;
}

.upload-btn {
    font-size: 18px;
    padding: 12px 24px;
    background-color: #f39c12;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease-in-out;
}

.upload-btn:hover {
    background-color: #e67e22;
}

#audio-controls {
    margin-top: 20px;
    width: 100%;
}

#current-time {
    font-size: 18px;
    margin-top: 10px;
}

.progress-container {
    width: 100%;
    max-width: 500px;
    height: 12px;
    background-color: #444;
    border-radius: 6px;
    margin: 20px auto;
    position: relative;
    cursor: pointer;
}

.progress-bar {
    height: 100%;
    background-color: #f39c12;
    width: 0%;
    border-radius: 6px;
    transition: width 0.1s linear;
}

canvas {
    margin-top: 40px;
    background: #222;
    border-radius: 12px;
}
</style>
</head>
<body>
<div class="container">
<h1>Welcome to Branden and Caden's Final Project for CS326-A!</h1>
<h2>Audio Player</h2>
<form>
    <label for="file-upload">Upload MP3:</label>
    <input type="file" id="file-upload" name="file-upload" title="Select an MP3 file">
</form>

<div id="audio-controls" style="display: none;">
    <button id="playPauseBtn" class="upload-btn">Play</button>
    <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div id="current-time">00:00</div>
</div>
</div>

<script>
// === Audio file setup ===
const AUDIO_FILE = "/path/to/your/audio/file.wav"; // Adjust to path or file you want
const FFT_SIZE = 2048;
const SAMPLE_RATE = 44100; // CD audio quality

// === Setup Web Audio API ===
let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let analyser = audioContext.createAnalyser();
analyser.fftSize = FFT_SIZE;  // Set FFT size
let bufferSourceNode = audioContext.createBufferSource();
let dataArray = new Float32Array(analyser.frequencyBinCount);

// === Setup Audio playback ===
let audio = new Audio();
audio.crossOrigin = "anonymous"; // Enable cross-origin requests for audio file if needed
let isPlaying = false;

// === Audio File Load and Setup ===
function loadAudioFile() {
    const fileInput = document.getElementById('file-upload');
    fileInput.addEventListener('change', function () {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function () {
                audio.src = reader.result;
                audio.load();
                audio.onloadedmetadata = () => {
                    document.getElementById('audio-controls').style.display = 'block';
                    startProcessingAudio();
                };
            };
            reader.readAsDataURL(file);
        }
    });
}

// === Audio Frequency Band Mapping ===
const BASS_CUTOFF = 200;  // Hz
const MID_CUTOFF = 2000;  // Hz

function startProcessingAudio() {
    let i = 0;

    function processAudio() {
        analyser.getFloatFrequencyData(dataArray);

        // Calculate frequency bins (based on FFT size and sample rate)
        const bass = dataArray.slice(0, Math.floor(BASS_CUTOFF * FFT_SIZE / SAMPLE_RATE));
        const mid = dataArray.slice(Math.floor(BASS_CUTOFF * FFT_SIZE / SAMPLE_RATE), Math.floor(MID_CUTOFF * FFT_SIZE / SAMPLE_RATE));
        const treble = dataArray.slice(Math.floor(MID_CUTOFF * FFT_SIZE / SAMPLE_RATE));

        // Calculate average value for each frequency band
        const avg = arr => arr.reduce((sum, v) => sum + v, 0) / arr.length;
        const bassVal = Math.floor(avg(bass));
        const midVal = Math.floor(avg(mid));
        const trebleVal = Math.floor(avg(treble));

        // Publish values to MQTT (or log to console)
        console.log("Bass:", bassVal);
        console.log("Mid:", midVal);
        console.log("Treble:", trebleVal);

        // Continue the audio processing
        if (!audio.paused) {
            requestAnimationFrame(processAudio);
        }
    }

    requestAnimationFrame(processAudio);
}

// === Play/Pause Control ===
function togglePlayPause() {
    if (isPlaying) {
        audio.pause();
        isPlaying = false;
    } else {
        audio.play();
        isPlaying = true;
    }
}

// === Load audio when page is ready ===
loadAudioFile();

// Example of usage: Trigger the play/pause when a button is clicked
document.getElementById("playPauseBtn").addEventListener("click", togglePlayPause);
</script>
</body>
</html>

